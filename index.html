<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Семейный бюджет</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/favicon.ico">
    
    <!-- Подключение внешних библиотек -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Индикаторы -->
    <div id="refresh-indicator" class="refresh-indicator"></div>
    <div id="offline-indicator" class="offline-indicator"></div>

    <!-- Шапка приложения -->
    <header class="app-header">
        <button class="btn theme-toggle">
            <img src="icons/theme.png" alt="Сменить тему" class="header-icon">
        </button>
        <h1>Семейный бюджет</h1>
        <button class="btn logout-btn">
            <img src="icons/logout.png" alt="Выйти" class="header-icon">
        </button>
    </header>

    <!-- Экран авторизации -->
    <div id="auth-screen" class="auth-screen">
        <h2>Семейный бюджет</h2>
        <form id="login-form" class="auth-form">
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Пароль" required>
            <button type="submit" class="btn">Войти</button>
        </form>
        <div id="auth-error" class="auth-error"></div>
    </div>

    <!-- Основное приложение -->
    <div id="app" class="app-container">
        <!-- Главная страница -->
        <section id="home" class="section">
            <h2>Обзор</h2>
            
            <!-- Основная статистика -->
            <div class="stats-grid">
                <div class="stat-card main-card">
                    <h3>Всего накоплено</h3>
                    <div class="value" id="total-savings">0 ₽</div>
                </div>
                
                <div class="stat-card">
                    <h3>Доход за месяц</h3>
                    <div class="value" id="monthly-income">0 ₽</div>
                </div>
                
                <div class="stat-card">
                    <h3>Расход за месяц</h3>
                    <div class="value" id="monthly-expense">0 ₽</div>
                </div>
            </div>

            <!-- Рублевые накопления -->
            <div class="card">
                <h3>Рублевые накопления</h3>
                <div class="value" id="ruble-savings-amount">0 ₽</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="ruble-progress-fill"></div>
                </div>
                <div class="info" id="ruble-progress-text">0% от цели</div>
            </div>

            <!-- Долларовые накопления -->
            <div class="card">
                <h3>Долларовые накопления</h3>
                <div class="value" id="dollar-savings-amount">0 $</div>
                <div class="info" id="dollar-savings-rub">0 ₽</div>
                <div class="info" id="dollar-rate">Курс: загрузка...</div>
            </div>

            <!-- Цель накоплений -->
            <div class="goal-section">
                <label for="savings-goal">Цель накоплений (₽)</label>
                <div class="input-group">
                    <input type="number" id="savings-goal" value="500000">
                    <button class="btn small save-goal-btn">Сохранить</button>
                </div>
            </div>

            <!-- Последние операции -->
            <h3>Последние операции</h3>
            <ul id="recent-transactions" class="transactions-list">
                <li class="loading-item">Загрузка...</li>
            </ul>
        </section>

        <!-- Добавление операции -->
        <section id="add" class="section hidden">
            <h2>Добавить операцию</h2>
            <form id="add-form" class="transaction-form">
                <input type="date" id="date" required>
                <input type="text" id="category" placeholder="Категория" required list="categories">
                <datalist id="categories"></datalist>
                
                <input type="number" id="amount" placeholder="Сумма" step="0.01" required>
                
                <select id="type" required>
                    <option value="income">Доход</option>
                    <option value="expense">Расход</option>
                </select>
                
                <input type="text" id="author" placeholder="Автор" required list="authors">
                <datalist id="authors"></datalist>
                
                <input type="text" id="comment" placeholder="Комментарий (необязательно)">
                
                <div class="toggle-container">
                    <span class="toggle-text">Долларовые накопления</span>
                    <input type="checkbox" id="dollar-savings" class="toggle-input">
                    <label for="dollar-savings" class="toggle-label">
                        <div class="toggle-button"></div>
                    </label>
                </div>
                
                <button type="submit" class="btn success">Добавить</button>
            </form>

            <!-- Форма редактирования -->
            <div id="edit-form" class="edit-form-container hidden">
                <h3>Редактировать операцию</h3>
                <form class="edit-form">
                    <input type="hidden" id="edit-id">
                    <input type="date" id="edit-date" required>
                    <input type="text" id="edit-category" placeholder="Категория" required list="edit-categories">
                    <datalist id="edit-categories"></datalist>
                    
                    <input type="number" id="edit-amount" placeholder="Сумма" step="0.01" required>
                    
                    <select id="edit-type" required>
                        <option value="income">Доход</option>
                        <option value="expense">Расход</option>
                    </select>
                    
                    <input type="text" id="edit-author" placeholder="Автор" required list="edit-authors">
                    <datalist id="edit-authors"></datalist>
                    
                    <input type="text" id="edit-comment" placeholder="Комментарий (необязательно)">
                    
                    <div class="toggle-container">
                        <span class="toggle-text">Долларовые накопления</span>
                        <input type="checkbox" id="edit-dollar-savings" class="toggle-input">
                        <label for="edit-dollar-savings" class="toggle-label">
                            <div class="toggle-button"></div>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn success">Сохранить</button>
                    <button type="button" class="btn secondary cancel-edit-btn">Отмена</button>
                </form>
            </div>
        </section>

        <!-- История операций -->
        <section id="list" class="section hidden">
            <h2>История операций</h2>
            
            <!-- Фильтры -->
            <div class="card">
                <h3>Фильтры</h3>
                <div class="filters-container">
                    <input type="date" id="filter-start" class="filter-input">
                    <input type="date" id="filter-end" class="filter-input">
                    <button class="btn small export-btn">Экспорт в Excel</button>
                </div>
            </div>
            
            <ul id="all-transactions" class="transactions-list">
                <li class="loading-item">Загрузка...</li>
            </ul>
        </section>

        <!-- Финансовый план -->
        <section id="plan" class="section hidden">
            <h2>Финансовый план</h2>
            
            <!-- Форма добавления/редактирования плана -->
            <div class="card">
                <h3>Добавить/редактировать план</h3>
                <form id="plan-form" class="plan-form">
                    <input type="month" id="plan-month" required>
                    <input type="number" id="plan-income" placeholder="Планируемый доход" step="0.01" required>
                    <input type="number" id="plan-expense" placeholder="Планируемый расход" step="0.01" required>
                    <button type="submit" class="btn success">Сохранить план</button>
                </form>
            </div>

            <!-- Импорт из Excel -->
            <div class="card">
                <h3>Импорт из Excel</h3>
                <div class="import-container">
                    <input type="file" id="import-plan-file" accept=".xlsx,.xls" class="file-input">
                    <button class="btn small import-btn">Импортировать</button>
                </div>
                <div class="import-info">
                    Формат: Месяц (ГГГГ-ММ), Доход, Расход
                </div>
            </div>

            <!-- Список планов -->
            <h3>Существующие планы</h3>
            <ul id="plan-list" class="plans-list">
                <li class="empty-item">Пока нет планов</li>
            </ul>
        </section>

        <!-- Аналитика -->
        <section id="analytics" class="section hidden">
            <h2>Аналитика</h2>
            
            <!-- Общая статистика -->
            <div class="card">
                <h3>Общая статистика</h3>
                <div class="stats-container">
                    <div class="stat-item">
                        <strong>Общий доход:</strong>
                        <div id="analytics-income">0 ₽</div>
                    </div>
                    <div class="stat-item">
                        <strong>Общий расход:</strong>
                        <div id="analytics-expense">0 ₽</div>
                    </div>
                </div>
            </div>

            <!-- Топ расходов -->
            <div class="card">
                <h3>Топ категорий расходов</h3>
                <ul id="top-expenses" class="expenses-list">
                    <li class="empty-item">Нет данных</li>
                </ul>
            </div>

            <!-- Ежемесячный план vs факт -->
            <div class="card">
                <h3>План vs Факт (<span id="current-month">Текущий месяц</span>)</h3>
                
                <div class="plan-fact-item">
                    <strong>Доходы</strong>
                    <div class="plan-fact-values">
                        <span>План: <span id="plan-income-value">0 ₽</span></span>
                        <span>Факт: <span id="fact-income-value">0 ₽</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-income-bar"></div>
                    </div>
                </div>
                
                <div class="plan-fact-item">
                    <strong>Расходы</strong>
                    <div class="plan-fact-values">
                        <span>План: <span id="plan-expense-value">0 ₽</span></span>
                        <span>Факт: <span id="fact-expense-value">0 ₽</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-expense-bar"></div>
                    </div>
                </div>
                
                <div class="savings-summary">
                    <strong>Накопления за месяц:</strong>
                    <div id="monthly-savings">0</div>
                </div>
            </div>

            <!-- BI аналитика -->
            <div class="card">
                <h3>BI аналитика</h3>
                
                <!-- Фильтры периода -->
                <div class="bi-filters">
                    <input type="date" id="bi-start-date" class="bi-filter-input">
                    <input type="date" id="bi-end-date" class="bi-filter-input">
                    <button class="btn small update-bi-btn">Обновить</button>
                    <button class="btn small secondary reset-bi-btn">Сбросить</button>
                </div>
                
                <!-- Графики -->
                <div class="chart-container">
                    <canvas id="expensePieChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="savingsWeeklyChart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <!-- Нижняя навигация -->
    <nav class="bottom-nav">
        <button class="nav-btn active" data-section="home">
            <img src="icons/home.png" alt="Главная" class="nav-icon">
            <span>Главная</span>
        </button>
        <button class="nav-btn" data-section="add">
            <img src="icons/add.png" alt="Добавить" class="nav-icon">
            <span>Добавить</span>
        </button>
        <button class="nav-btn" data-section="list">
            <img src="icons/list.png" alt="История" class="nav-icon">
            <span>История</span>
        </button>
        <button class="nav-btn" data-section="plan">
            <img src="icons/plan.png" alt="План" class="nav-icon">
            <span>План</span>
        </button>
        <button class="nav-btn" data-section="analytics">
            <img src="icons/analytics.png" alt="Аналитика" class="nav-icon">
            <span>Аналитика</span>
        </button>
    </nav>

    <!-- Регистрация Service Worker -->
    <script src="sw-register.js"></script>
    
    <!-- Основной скрипт приложения как ES6 модуль -->
    <script type="module" src="app.js"></script>
</body>
</html>
